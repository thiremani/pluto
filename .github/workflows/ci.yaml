name: Pluto CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      # Following the instruction on https://tinygo.org/docs/guides/build/bring-your-own-llvm/
      - name: Install LLVM and Dependencies
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 21  # Install LLVM 21
          sudo apt-get install -y llvm-21-dev lld-21 clang-21 valgrind

      - name: Set LLVM environment
        run: |
          echo "CGO_CFLAGS=-I/usr/lib/llvm-21/include" >> $GITHUB_ENV
          echo "CGO_LDFLAGS=-L/usr/lib/llvm-21/lib" >> $GITHUB_ENV
          echo "/usr/lib/llvm-21/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=/usr/lib/llvm-21/lib" >> $GITHUB_ENV

      - name: Verify LLVM Tools
        run: |
          llvm-config-21 --version
          clang-21 --version
          ld.lld-21 --version

      - name: Check Go formatting (gofmt)
        run: |
          CHANGED=$(gofmt -l .)
          if [ -n "$CHANGED" ]; then
            echo "gofmt found issues in:" >&2
            echo "$CHANGED" >&2
            gofmt -d . >&2
            exit 1
          fi

      - name: Run full test suite with memory leak checks
        run: |
          python3 --version
          python3 test.py --leak-check
